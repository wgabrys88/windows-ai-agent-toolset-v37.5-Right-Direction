<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FRANZ Panel</title>
<style>
:root {
    --bg: #0a0a0f; --card: #12121a; --hover: #1a1a25; --border: #2a2a3a;
    --text: #d0d0e0; --dim: #707088; --accent: #4a9eff;
    --green: #40c040; --red: #e04040; --orange: #e0a020; --purple: #c080ff;
    --mono: 'Consolas', 'Courier New', monospace;
    --hdr: 36px; --ctrl: 32px;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    background: var(--bg); color: var(--text);
    font-family: 'Segoe UI', sans-serif; font-size: 14px;
    overflow: hidden; height: 100vh; width: 100vw;
}
.header {
    height: var(--hdr); background: var(--bg); border-bottom: 1px solid var(--border);
    padding: 0 16px; display: flex; align-items: center; gap: 16px;
}
.header h1 { font-size: 15px; font-weight: 700; color: var(--accent); letter-spacing: 2px; }
.dot {
    width: 7px; height: 7px; border-radius: 50%; background: var(--red);
    transition: background 0.3s; display: inline-block; margin-right: 4px;
}
.dot.on { background: var(--green); box-shadow: 0 0 5px var(--green); }
.header .info { margin-left: auto; font-size: 11px; color: var(--dim); font-family: var(--mono); }
.header .info span { color: var(--text); }
.controls {
    height: var(--ctrl); padding: 0 16px; border-bottom: 1px solid var(--border);
    display: flex; gap: 10px; align-items: center; font-size: 11px;
}
.controls label { display: flex; align-items: center; gap: 4px; color: var(--dim); cursor: pointer; user-select: none; }
.controls input[type="checkbox"] { accent-color: var(--accent); }
.controls button {
    background: var(--card); border: 1px solid var(--border); color: var(--text);
    padding: 3px 10px; border-radius: 4px; cursor: pointer; font-size: 11px;
}
.controls button:hover { background: var(--hover); border-color: var(--accent); }
.controls button.active { background: rgba(224,64,64,0.15); border-color: var(--red); color: var(--red); }
.nav { margin-left: auto; display: flex; align-items: center; gap: 6px; font-family: var(--mono); color: var(--dim); }
.nav button { min-width: 28px; text-align: center; }
.nav .ind { min-width: 80px; text-align: center; color: var(--text); }
.main { position: relative; width: 100%; height: calc(100vh - var(--hdr) - var(--ctrl)); overflow: hidden; }
.q { position: absolute; overflow: hidden; display: flex; flex-direction: column; }
.q-hdr {
    height: 22px; min-height: 22px; padding: 0 10px; display: flex; align-items: center;
    font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
    border-bottom: 1px solid var(--border); user-select: none;
}
.q-body {
    flex: 1; overflow-y: auto; overflow-x: hidden; padding: 8px 10px;
    font-family: var(--mono); font-size: 12px; line-height: 1.6;
    white-space: pre-wrap; word-break: break-word;
}
.q-body.empty { color: var(--dim); font-style: italic; }
#qTL { top: 0; left: 0; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); }
#qTR { top: 0; border-bottom: 1px solid var(--border); }
#qBL { left: 0; border-right: 1px solid var(--border); }
#qTL .q-hdr { color: var(--accent); background: rgba(74,158,255,0.06); }
#qTR .q-hdr { color: var(--green); background: rgba(64,192,64,0.06); }
#qBL .q-hdr { color: var(--orange); background: rgba(224,160,32,0.06); }
#qBR .q-hdr { color: var(--purple); background: rgba(192,128,255,0.06); }
#qBR .q-body { padding: 0; display: flex; align-items: center; justify-content: center; }
#qBR .q-body img { width: 100%; height: 100%; object-fit: contain; cursor: pointer; }
.cross-c { position: absolute; z-index: 70; border-radius: 50%; cursor: move; }
.cross-c:hover { background: rgba(74,158,255,0.5); }
.sst-badge { padding: 1px 6px; border-radius: 3px; font-size: 10px; font-weight: 600; font-family: var(--mono); margin-left: 8px; }
.sst-ok { background: rgba(64,192,64,0.15); color: var(--green); }
.sst-fail { background: rgba(224,64,64,0.15); color: var(--red); }
.err-block { margin-top: 8px; padding: 6px 8px; background: rgba(224,64,64,0.05); border: 1px solid rgba(224,64,64,0.3); border-radius: 3px; font-size: 11px; color: var(--red); }
.meta { margin-top: 8px; padding-top: 6px; border-top: 1px solid var(--border); font-size: 11px; display: grid; grid-template-columns: auto 1fr; gap: 1px 10px; }
.meta .k { color: var(--dim); } .meta .v { color: var(--text); }
.overlay {
    display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.95); z-index: 200; flex-direction: column; align-items: center; padding: 16px;
}
.overlay.visible { display: flex; }
.overlay .toolbar { display: flex; gap: 10px; margin-bottom: 12px; align-items: center; flex-wrap: wrap; }
.overlay .toolbar button { background: var(--card); border: 1px solid var(--border); color: var(--text); padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; }
.overlay .toolbar button:hover { background: var(--hover); border-color: var(--accent); }
.overlay .toolbar label { display: flex; align-items: center; gap: 4px; color: var(--dim); font-size: 11px; cursor: pointer; user-select: none; }
.overlay .toolbar input[type="checkbox"] { accent-color: var(--accent); }
.overlay .img-wrap { position: relative; flex: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; }
.overlay .img-wrap img { max-width: 100%; max-height: 100%; object-fit: contain; user-select: none; -webkit-user-drag: none; }
.overlay .sel-rect { position: absolute; border: 2px solid var(--accent); background: rgba(74,158,255,0.15); pointer-events: none; }
.overlay .crop-info { color: var(--accent); font-family: var(--mono); font-size: 12px; margin-top: 8px; }
::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<div class="header">
    <h1>FRANZ</h1>
    <div><span class="dot" id="dot"></span><span id="conn">Disconnected</span></div>
    <div class="info">
        Turns: <span id="sTurns">0</span> |
        Latency: <span id="sLat">--</span> |
        SST: <span id="sSst">0</span> |
        Err: <span id="sErr">0</span>
    </div>
</div>

<div class="controls">
    <label><input type="checkbox" id="chkAuto" checked> Auto-advance</label>
    <button id="btnPause">Pause</button>
    <button id="btnRegion">Select Region</button>
    <button id="btnTools">Tools</button>
    <button id="btnClear">Clear</button>
    <div class="nav">
        <button id="bFirst">&lt;&lt;</button>
        <button id="bPrev">&lt;</button>
        <span class="ind" id="ind">--</span>
        <button id="bNext">&gt;</button>
        <button id="bLast">&gt;&gt;</button>
    </div>
</div>

<div class="main" id="main">
    <div class="q" id="qTL">
        <div class="q-hdr">VLM Input (Full)</div>
        <div class="q-body empty" id="cTL">(waiting)</div>
    </div>
    <div class="q" id="qTR">
        <div class="q-hdr">VLM Output</div>
        <div class="q-body empty" id="cTR">(waiting)</div>
    </div>
    <div class="q" id="qBL">
        <div class="q-hdr">Turn Info</div>
        <div class="q-body empty" id="cBL">(waiting)</div>
    </div>
    <div class="q" id="qBR">
        <div class="q-hdr">Screenshot</div>
        <div class="q-body empty" id="cBR">(waiting)</div>
    </div>
    <div class="cross-c" id="crossC"></div>

    <div class="overlay" id="regionOverlay">
        <div class="toolbar">
            <button id="regionRefresh">Refresh Preview</button>
            <button id="regionClear">Clear Selection</button>
            <button id="regionApply">Apply Crop</button>
            <button id="regionClose">Close</button>
        </div>
        <div class="img-wrap" id="imgWrap">
            <img id="previewImg" draggable="false">
            <div class="sel-rect" id="selRect" style="display:none"></div>
        </div>
        <div class="crop-info" id="cropInfo">No region selected (full screen)</div>
    </div>

    <div class="overlay" id="toolsOverlay">
        <div class="toolbar">
            <span style="color:var(--accent);font-weight:600">Allowed Tools</span>
            <button id="toolsAll">Enable All</button>
            <button id="toolsNone">Disable All</button>
            <button id="toolsClose">Close</button>
        </div>
        <div id="toolsList" style="display:flex;flex-direction:column;gap:8px;padding:16px;font-size:13px"></div>
    </div>
</div>

<script>
(function() {
    "use strict";

    var turns = [];
    var ci = -1;
    var totLat = 0, nViol = 0, nErr = 0;
    var es = null;
    var sx = 0.55, sy = 0.50;
    var paused = false;
    var allTools = ["click", "right_click", "double_click", "drag", "write", "remember", "recall"];
    var enabledTools = allTools.slice();

    var g = function(id) { return document.getElementById(id); };
    var dot = g("dot"), conn = g("conn");
    var sTurns = g("sTurns"), sLat = g("sLat"), sSst = g("sSst"), sErr = g("sErr");
    var ma = g("main");
    var qTL = g("qTL"), qTR = g("qTR"), qBL = g("qBL"), qBR = g("qBR");
    var cTL = g("cTL"), cTR = g("cTR"), cBL = g("cBL"), cBR = g("cBR");
    var cc = g("crossC");
    var chkAuto = g("chkAuto");
    var btnP = g("btnPause");
    var ind = g("ind");

    function esc(s) {
        if (!s) return "";
        return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    }

    function xhr(method, url, body, cb) {
        var x = new XMLHttpRequest();
        x.open(method, url, true);
        if (body !== null) x.setRequestHeader("Content-Type", "application/json");
        x.timeout = 10000;
        x.onload = function() { if (cb) try { cb(JSON.parse(x.responseText)); } catch(e) {} };
        x.send(body !== null ? (typeof body === "string" ? body : JSON.stringify(body)) : null);
    }

    function layout() {
        var w = ma.offsetWidth, h = ma.offsetHeight;
        var fx = Math.max(0.15, Math.min(0.85, sx));
        var fy = Math.max(0.15, Math.min(0.85, sy));
        var hp = 4;
        var lw = Math.round(w * fx) - hp;
        var rw = w - lw - hp * 2;
        var th = Math.round(h * fy) - hp;
        var bh = h - th - hp * 2;
        var rx = lw + hp * 2, by = th + hp * 2;

        qTL.style.cssText = "left:0;top:0;width:" + lw + "px;height:" + th + "px";
        qTR.style.cssText = "left:" + rx + "px;top:0;width:" + rw + "px;height:" + th + "px";
        qBL.style.cssText = "left:0;top:" + by + "px;width:" + lw + "px;height:" + bh + "px";
        qBR.style.cssText = "left:" + rx + "px;top:" + by + "px;width:" + rw + "px;height:" + bh + "px";

        var cs = hp * 5;
        cc.style.cssText = "position:absolute;left:" + (lw - cs/2) + "px;top:" + (th - cs/2) +
            "px;width:" + cs + "px;height:" + cs + "px;border-radius:50%;cursor:move;z-index:70;pointer-events:auto";
    }

    (function() {
        var drag = false;
        cc.addEventListener("mousedown", function(e) {
            e.preventDefault(); drag = true;
            document.body.style.cursor = "move"; document.body.style.userSelect = "none";
        });
        document.addEventListener("mousemove", function(e) {
            if (!drag) return;
            var r = ma.getBoundingClientRect();
            sx = (e.clientX - r.left) / r.width;
            sy = (e.clientY - r.top) / r.height;
            layout();
        });
        document.addEventListener("mouseup", function() {
            if (drag) { drag = false; document.body.style.cursor = ""; document.body.style.userSelect = ""; }
        });
    })();

    window.addEventListener("resize", layout);
    layout();

    function stats() {
        sTurns.textContent = turns.length;
        sLat.textContent = turns.length > 0 ? Math.round(totLat / turns.length) + "ms" : "--";
        sSst.textContent = nViol;
        sErr.textContent = nErr;
        if (nViol > 0) sSst.style.color = "#e04040";
        if (nErr > 0) sErr.style.color = "#e0a020";
    }

    function updInd() {
        if (turns.length === 0) { ind.textContent = "--"; return; }
        ind.textContent = "Turn " + (turns[ci].turn || ci + 1) + " / " + turns.length;
    }

    function show(idx) {
        if (idx < 0 || idx >= turns.length) return;
        ci = idx;
        var e = turns[idx];
        var req = e.request || {};
        var resp = e.response || {};
        var sst = e.sst_check || {};
        var usage = resp.usage || {};

        var inputText = req.feedback_text_full || req.feedback_text || "";
        var sstOk = !sst.verified || sst.match;
        var badge = '<span class="sst-badge ' + (sstOk ? "sst-ok" : "sst-fail") + '">' +
            (sstOk ? "SST OK" : "SST FAIL") + '</span>';

        cTL.innerHTML = (inputText ? esc(inputText) : '<span style="color:var(--dim)">(empty)</span>') +
            "\n" + badge;
        if (!sstOk && sst.detail) cTL.innerHTML += '\n<div class="err-block">' + esc(sst.detail) + '</div>';
        cTL.classList.remove("empty");

        var vlm = resp.vlm_text || "";
        if (vlm) { cTR.textContent = vlm; cTR.classList.remove("empty"); }
        else { cTR.innerHTML = '<span style="color:var(--dim)">(empty)</span>'; cTR.classList.add("empty"); }
        if (resp.error) cTR.innerHTML += '\n<div class="err-block">' + esc(resp.error) + '</div>';

        var meta = '<div class="meta">';
        var items = [
            ["turn", e.turn], ["latency", Math.round(e.latency_ms || 0) + "ms"],
            ["status", resp.status], ["finish", resp.finish_reason || "?"],
            ["prompt_tok", usage.prompt_tokens != null ? usage.prompt_tokens : "?"],
            ["compl_tok", usage.completion_tokens != null ? usage.completion_tokens : "?"],
            ["model", req.model], ["timestamp", e.timestamp || ""],
        ];
        for (var i = 0; i < items.length; i++)
            meta += '<div class="k">' + items[i][0] + '</div><div class="v">' + esc(String(items[i][1])) + '</div>';
        meta += '</div>';
        if (resp.parse_error) meta += '<div class="err-block">Parse: ' + esc(resp.parse_error) + '</div>';
        cBL.innerHTML = meta;
        cBL.classList.remove("empty");

        var uri = req.image_data_uri || "";
        if (req.has_image && uri) {
            cBR.innerHTML = '<img src="' + uri + '" onclick="window.open(this.src)">';
            cBR.classList.remove("empty");
        } else {
            cBR.innerHTML = '<span style="color:var(--dim)">(no screenshot)</span>';
            cBR.classList.add("empty");
        }
        updInd();
    }

    g("bFirst").addEventListener("click", function() { if (turns.length > 0) show(0); });
    g("bPrev").addEventListener("click", function() { if (ci > 0) show(ci - 1); });
    g("bNext").addEventListener("click", function() { if (ci < turns.length - 1) show(ci + 1); });
    g("bLast").addEventListener("click", function() { if (turns.length > 0) show(turns.length - 1); });

    document.addEventListener("keydown", function(e) {
        if (g("regionOverlay").classList.contains("visible")) return;
        if (g("toolsOverlay").classList.contains("visible")) return;
        if (e.key === "ArrowLeft") { if (ci > 0) show(ci - 1); }
        else if (e.key === "ArrowRight") { if (ci < turns.length - 1) show(ci + 1); }
        else if (e.key === "Home") { if (turns.length > 0) show(0); }
        else if (e.key === "End") { if (turns.length > 0) show(turns.length - 1); }
    });

    g("btnClear").addEventListener("click", function() {
        turns = []; ci = -1; totLat = 0; nViol = 0; nErr = 0;
        stats(); updInd();
        [cTL, cTR, cBL, cBR].forEach(function(el) {
            el.innerHTML = '<span style="color:var(--dim)">(waiting)</span>';
            el.classList.add("empty");
        });
    });

    function updPause() {
        btnP.textContent = paused ? "Resume" : "Pause";
        if (paused) btnP.classList.add("active"); else btnP.classList.remove("active");
    }

    function pollPause() {
        xhr("GET", "/health", null, function(d) { paused = !!d.paused; updPause(); });
    }

    btnP.addEventListener("click", function() {
        xhr("POST", paused ? "/unpause" : "/pause", {}, function(d) { paused = !!d.paused; updPause(); });
    });

    setInterval(pollPause, 5000);
    pollPause();

    // --- Region selection overlay ---
    var regionOv = g("regionOverlay");
    var previewImg = g("previewImg");
    var selRect = g("selRect");
    var imgWrap = g("imgWrap");
    var cropInfo = g("cropInfo");
    var selStart = null;
    var selBox = null;
    var previewNatW = 0, previewNatH = 0;
    var screenW = 1920, screenH = 1080;

    function loadPreview() {
        xhr("GET", "/preview", null, function(d) {
            if (d.image_b64) {
                previewImg.src = "data:image/png;base64," + d.image_b64;
                previewImg.onload = function() {
                    previewNatW = previewImg.naturalWidth;
                    previewNatH = previewImg.naturalHeight;
                };
            }
        });
        xhr("GET", "/health", null, function() {});
    }

    function imgCoords(e) {
        var r = previewImg.getBoundingClientRect();
        var x = Math.max(0, Math.min(1, (e.clientX - r.left) / r.width));
        var y = Math.max(0, Math.min(1, (e.clientY - r.top) / r.height));
        return {x: x, y: y};
    }

    function updateSelRect() {
        if (!selBox) { selRect.style.display = "none"; cropInfo.textContent = "No region selected (full screen)"; return; }
        var r = previewImg.getBoundingClientRect();
        var wr = imgWrap.getBoundingClientRect();
        var ox = r.left - wr.left, oy = r.top - wr.top;
        selRect.style.display = "block";
        selRect.style.left = (ox + selBox.x1 * r.width) + "px";
        selRect.style.top = (oy + selBox.y1 * r.height) + "px";
        selRect.style.width = ((selBox.x2 - selBox.x1) * r.width) + "px";
        selRect.style.height = ((selBox.y2 - selBox.y1) * r.height) + "px";

        var sw = screenW || 1920, sh = screenH || 1080;
        var px1 = Math.round(selBox.x1 * sw), py1 = Math.round(selBox.y1 * sh);
        var px2 = Math.round(selBox.x2 * sw), py2 = Math.round(selBox.y2 * sh);
        cropInfo.textContent = "Crop: (" + px1 + "," + py1 + ")-(" + px2 + "," + py2 + ") = " +
            (px2 - px1) + "x" + (py2 - py1) + "px";
    }

    previewImg.addEventListener("mousedown", function(e) {
        e.preventDefault();
        selStart = imgCoords(e);
        selBox = null;
        updateSelRect();
    });

    previewImg.addEventListener("mousemove", function(e) {
        if (!selStart) return;
        var cur = imgCoords(e);
        selBox = {
            x1: Math.min(selStart.x, cur.x), y1: Math.min(selStart.y, cur.y),
            x2: Math.max(selStart.x, cur.x), y2: Math.max(selStart.y, cur.y),
        };
        updateSelRect();
    });

    document.addEventListener("mouseup", function() {
        if (selStart) { selStart = null; updateSelRect(); }
    });

    g("btnRegion").addEventListener("click", function() {
        regionOv.classList.add("visible");
        loadPreview();
        xhr("GET", "/crop", null, function(d) {
            if (d && d.x1 != null) {
                var sw = screenW || 1920, sh = screenH || 1080;
                selBox = {x1: d.x1/sw, y1: d.y1/sh, x2: d.x2/sw, y2: d.y2/sh};
                updateSelRect();
            }
        });
    });

    g("regionRefresh").addEventListener("click", loadPreview);

    g("regionClear").addEventListener("click", function() {
        selBox = null;
        updateSelRect();
        xhr("POST", "/crop", {}, function() { cropInfo.textContent = "Cleared (full screen)"; });
    });

    g("regionApply").addEventListener("click", function() {
        if (!selBox) {
            xhr("POST", "/crop", {}, function() { cropInfo.textContent = "Cleared (full screen)"; });
            return;
        }
        var sw = screenW || 1920, sh = screenH || 1080;
        var crop = {
            x1: Math.round(selBox.x1 * sw), y1: Math.round(selBox.y1 * sh),
            x2: Math.round(selBox.x2 * sw), y2: Math.round(selBox.y2 * sh),
        };
        xhr("POST", "/crop", crop, function(d) {
            if (d && d.ok) cropInfo.textContent = "Applied: " + JSON.stringify(d.crop);
        });
    });

    g("regionClose").addEventListener("click", function() { regionOv.classList.remove("visible"); });

    // --- Tools overlay ---
    var toolsOv = g("toolsOverlay");
    var toolsList = g("toolsList");

    function renderTools() {
        toolsList.innerHTML = "";
        allTools.forEach(function(t) {
            var lbl = document.createElement("label");
            lbl.style.cssText = "display:flex;align-items:center;gap:8px;color:var(--text);cursor:pointer;user-select:none";
            var cb = document.createElement("input");
            cb.type = "checkbox";
            cb.checked = enabledTools.indexOf(t) >= 0;
            cb.style.accentColor = "var(--accent)";
            cb.addEventListener("change", function() {
                if (cb.checked) { if (enabledTools.indexOf(t) < 0) enabledTools.push(t); }
                else { enabledTools = enabledTools.filter(function(x) { return x !== t; }); }
                saveTools();
            });
            lbl.appendChild(cb);
            lbl.appendChild(document.createTextNode(t));
            toolsList.appendChild(lbl);
        });
    }

    function saveTools() {
        xhr("POST", "/allowed_tools", enabledTools, function() {});
    }

    function loadTools() {
        xhr("GET", "/allowed_tools", null, function(d) {
            if (Array.isArray(d)) enabledTools = d;
            renderTools();
        });
    }

    g("btnTools").addEventListener("click", function() {
        toolsOv.classList.add("visible");
        loadTools();
    });

    g("toolsAll").addEventListener("click", function() {
        enabledTools = allTools.slice();
        renderTools(); saveTools();
    });

    g("toolsNone").addEventListener("click", function() {
        enabledTools = [];
        renderTools(); saveTools();
    });

    g("toolsClose").addEventListener("click", function() { toolsOv.classList.remove("visible"); });

    // Get screen size from first preview
    xhr("GET", "/preview", null, function(d) {
        if (d.image_b64) {
            var img = new Image();
            img.onload = function() {
                // Preview is max 960px wide, proportional. Estimate real screen from aspect ratio.
                // For accurate values we'd need the server to tell us. Use 1920x1080 as default.
                // The crop coordinates are in real pixels so this is fine.
            };
            img.src = "data:image/png;base64," + d.image_b64;
        }
    });

    function connect() {
        if (es) es.close();
        es = new EventSource("/events");
        es.onopen = function() { dot.classList.add("on"); conn.textContent = "Connected"; };
        es.onmessage = function(evt) {
            try {
                var d = JSON.parse(evt.data);
                if (d.type === "connected") return;
                turns.push(d);
                totLat += (d.latency_ms || 0);
                var sst = d.sst_check || {};
                if (sst.verified && !sst.match) nViol++;
                if ((d.response || {}).error) nErr++;
                stats();
                if (chkAuto.checked) show(turns.length - 1); else updInd();
            } catch(e) {}
        };
        es.onerror = function() { dot.classList.remove("on"); conn.textContent = "Reconnecting..."; };
    }

    connect();
})();
</script>
</body>
</html>
